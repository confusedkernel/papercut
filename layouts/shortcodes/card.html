{{- $link := .Get "link" | default ( .Get "url" | default "#" ) -}}
{{- $title := .Get "title" | default "Card" -}}
{{- $subtitle := .Get "subtitle" | default "" -}}
{{- $icon := .Get "icon" | default "" -}}
{{- $image := .Get "image" | default "" -}}
{{- $imageAlt := .Get "imageAlt" | default $title -}}
{{- $imageStyle := .Get "imageStyle" | default "" -}}
{{- $method := .Get "method" | default "Resize" -}}
{{- $options := .Get "options" | default "800x q80 webp" -}}
{{- $tag := .Get "tag" | default "" -}}
{{- $target := .Get "target" | default "" -}}
{{- if eq $target "" -}}
  {{- if or (hasPrefix $link "http://") (hasPrefix $link "https://") -}}
    {{- $target = "_blank" -}}
  {{- else -}}
    {{- $target = "_self" -}}
  {{- end -}}
{{- end -}}
{{- $rel := .Get "rel" | default "" -}}
{{- if and (eq $target "_blank") (eq $rel "") -}}
  {{- $rel = "noopener noreferrer" -}}
{{- end -}}

{{- $imageSrc := "" -}}
{{- if $image -}}
  {{- if or (hasPrefix $image "http://") (hasPrefix $image "https://") -}}
    {{- $imageSrc = $image -}}
  {{- else if hasPrefix $image "/" -}}
    {{- $imageSrc = $image | relURL -}}
  {{- else -}}
    {{- $imageResource := resources.Get $image -}}
    {{- if and (not $imageResource) .Page -}}
      {{- $imageResource = .Page.Resources.GetMatch $image -}}
    {{- end -}}
    {{- if $imageResource -}}
      {{- $methodKey := lower $method -}}
      {{- if eq $methodKey "fit" -}}
        {{- $imageResource = $imageResource.Fit $options -}}
      {{- else if eq $methodKey "fill" -}}
        {{- $imageResource = $imageResource.Fill $options -}}
      {{- else if eq $methodKey "crop" -}}
        {{- $imageResource = $imageResource.Crop $options -}}
      {{- else -}}
        {{- $imageResource = $imageResource.Resize $options -}}
      {{- end -}}
      {{- $imageSrc = $imageResource.RelPermalink -}}
    {{- else -}}
      {{- $imageSrc = $image | relURL -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $iconValue := strings.TrimSpace $icon -}}
{{- $iconLower := lower $iconValue -}}
{{- $iconIsFavicon := eq $iconLower "favicon" -}}
{{- $iconIsExternal := or (hasPrefix $iconValue "http://") (hasPrefix $iconValue "https://") -}}
{{- $iconIsAbsolute := hasPrefix $iconValue "/" -}}
{{- $iconIsData := hasPrefix $iconValue "data:" -}}
{{- $iconLooksLikeFile := gt (len (findRE "\\.(svg|png|jpe?g|webp|gif|ico)(\\?.*)?$" $iconLower)) 0 -}}
{{- $iconIsRelativePath := and (not $iconIsExternal) (not $iconIsAbsolute) (not $iconIsData) (or (hasPrefix $iconValue "./") (hasPrefix $iconValue "../") (gt (len (findRE "/" $iconValue)) 0) $iconLooksLikeFile) -}}
{{- $iconImageSrc := "" -}}
{{- $iconFallbackSrc := "" -}}
{{- if and $iconIsFavicon (or (hasPrefix $link "http://") (hasPrefix $link "https://")) -}}
  {{- $host := replaceRE "^https?://([^/:?#]+).*$" "$1" $link -}}
  {{- $origin := replaceRE "^(https?://[^/?#]+).*$" "$1" $link -}}
  {{- if and $origin (ne $origin $link) -}}
    {{- $iconFallbackSrc = printf "%s/favicon.ico" $origin -}}
  {{- end -}}
  {{- if and $host (ne $host $link) -}}
    {{- $iconImageSrc = printf "https://www.google.com/s2/favicons?domain=%s&sz=64" ($host | urlquery) -}}
  {{- end -}}
{{- else if or $iconIsExternal $iconIsAbsolute $iconIsData $iconIsRelativePath -}}
  {{- if $iconIsExternal -}}
    {{- $iconImageSrc = $iconValue -}}
  {{- else -}}
    {{- $iconImageSrc = $iconValue | relURL -}}
  {{- end -}}
{{- end -}}
{{- $iconName := "" -}}
{{- if and (eq $iconImageSrc "") (ne $iconValue "") (not $iconIsFavicon) -}}
  {{- $iconName = $iconValue -}}
{{- end -}}
{{- $iconFallbackAttr := "" -}}
{{- with $iconFallbackSrc -}}
  {{- $iconFallbackAttr = printf "onerror=%q" (printf "if(!this.dataset.faviconFallbackTried){this.dataset.faviconFallbackTried='1';this.src='%s';}" .) -}}
{{- end -}}

{{- $hasSubtitle := ne (strings.TrimSpace $subtitle) "" -}}
{{- $isIconTitleOnly := and (eq (strings.TrimSpace $tag) "") (not $hasSubtitle) (or (ne $iconName "") (ne $iconImageSrc "")) -}}

<a class="sc-card{{ if $imageSrc }} sc-card--image{{ end }}{{ if $isIconTitleOnly }} sc-card--icon-title{{ end }}" href="{{ $link }}" target="{{ $target }}"{{ with $rel }} rel="{{ . }}"{{ end }}>
  {{- with $imageSrc -}}
    <span class="sc-card__image-wrap"><img class="sc-card__image" src="{{ . }}" alt="{{ $imageAlt }}" loading="lazy"{{ with $imageStyle }} style="{{ . }}"{{ end }} /></span>
  {{- end -}}
  <span class="sc-card__body">
    {{- if $isIconTitleOnly -}}
      <span class="sc-card__headline">
        {{- if $iconImageSrc -}}
          <img class="sc-card__icon-image sc-card__icon-image--headline" src="{{ $iconImageSrc }}" alt="" loading="lazy" {{ with $iconFallbackAttr }}{{ . | safeHTMLAttr }}{{ end }} />
        {{- else -}}
          {{ partial "shortcode-icon.html" (dict "name" $iconName "class" "sc-card__icon sc-card__icon--headline" "size" "1rem") }}
        {{- end -}}
        <span class="sc-card__title">{{ $title }}</span>
      </span>
    {{- else -}}
      {{- if or $iconName $iconImageSrc $tag -}}
        <span class="sc-card__meta">
          {{- if $iconImageSrc -}}
            <img class="sc-card__icon-image" src="{{ $iconImageSrc }}" alt="" loading="lazy" {{ with $iconFallbackAttr }}{{ . | safeHTMLAttr }}{{ end }} />
          {{- else -}}
            {{- with $iconName -}}
              {{ partial "shortcode-icon.html" (dict "name" . "class" "sc-card__icon" "size" "1rem") }}
            {{- end -}}
          {{- end -}}
          {{- with $tag -}}<span class="sc-card__tag">{{ . }}</span>{{- end -}}
        </span>
      {{- end -}}
      <span class="sc-card__title">{{ $title }}</span>
      {{- with $subtitle -}}<div class="sc-card__subtitle">{{ . | markdownify }}</div>{{- end -}}
    {{- end -}}
  </span>
</a>
