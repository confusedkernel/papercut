{{ define "main" }}
  {{ $isTaxonomyList := eq .Kind "taxonomy" }}
  {{ $taxonomyName := .Data.Plural }}
  {{ if eq $taxonomyName "" }}
    {{ $taxonomyName = .Section }}
  {{ end }}

  {{ $normalizedCounts := dict }}
  {{ if and $isTaxonomyList (ne $taxonomyName "") }}
    {{ $normalizedCounts = partial "taxonomy-counts.html" (dict "taxonomyName" $taxonomyName "site" .Site) }}
  {{ end }}

  {{ $matchingPages := .Pages }}
  {{ if and (not $isTaxonomyList) (ne $taxonomyName "") }}
    {{ $termKey := lower (strings.TrimSpace .Title) }}
    {{ $matchingPages = slice }}
    {{ range .Site.RegularPages }}
      {{ $page := . }}
      {{ $rawTerms := $page.Param $taxonomyName }}
      {{ $terms := slice }}
      {{ if reflect.IsSlice $rawTerms }}
        {{ $terms = $rawTerms }}
      {{ else if $rawTerms }}
        {{ $terms = slice $rawTerms }}
      {{ end }}

      {{ $matchesTerm := false }}
      {{ range $terms }}
        {{ $value := lower (strings.TrimSpace (printf "%v" .)) }}
        {{ if eq $value $termKey }}
          {{ $matchesTerm = true }}
        {{ end }}
      {{ end }}

      {{ if $matchesTerm }}
        {{ $matchingPages = $matchingPages | append $page }}
      {{ end }}
    {{ end }}
    {{ $matchingPages = sort $matchingPages "Date" "desc" }}
  {{ end }}

  <section class="border border-[var(--border)] bg-[var(--bg-alt)] p-5 shadow-[0_14px_24px_-18px_rgba(0,0,0,0.35)] sm:p-6">
    <nav aria-label="Breadcrumb" class="text-sm uppercase tracking-[0.08em] text-[var(--muted)]">
      {{ if $isTaxonomyList }}
        <span>Taxonomies</span>
        <span class="px-2">&gt;</span>
        <span class="text-[var(--fg)]">{{ .Title | humanize | title }}</span>
      {{ else }}
        <a class="hover:underline" href="{{ printf "/%s/" .Data.Plural | relURL }}">{{ .Data.Plural | humanize | title }}</a>
        <span class="px-2">&gt;</span>
        <span class="text-[var(--fg)]">{{ .Title | humanize | title }}</span>
      {{ end }}
    </nav>
    <h1 class="mt-2 text-2xl sm:text-3xl">{{ .Title | humanize | title }}</h1>
  </section>

  {{ if $isTaxonomyList }}
    <section class="flex flex-col gap-4">
      <ul class="flex flex-wrap gap-2">
        {{ $seenTerms := dict }}
        {{ range .Data.Terms.Alphabetical }}
          {{ $termKey := lower (strings.TrimSpace .Page.Title) }}
          {{ if not (index $seenTerms $termKey) }}
            {{ $seenTerms = merge $seenTerms (dict $termKey true) }}
            {{ $termCount := index $normalizedCounts $termKey | default (len .Page.RegularPages) }}
            <li>
              <a
                class="index-hover border border-[var(--border)] bg-[var(--bg-alt)] px-3 py-1.5 text-[0.72rem] tracking-[0.04em] text-[var(--muted)] hover:text-[var(--fg)]"
                href="{{ printf "/%s/%s/" $taxonomyName ($termKey | urlize) | relURL }}"
              >
                {{ .Page.Title }}<sup class="ml-1 text-[0.6rem]">{{ $termCount }}</sup>
              </a>
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </section>
  {{ else }}
    <section class="flex flex-col gap-4">
      <div class="flex flex-col gap-4">
        {{ range $matchingPages }}
          {{ partial "article-card.html" . }}
        {{ end }}
      </div>
    </section>
  {{ end }}
{{ end }}
